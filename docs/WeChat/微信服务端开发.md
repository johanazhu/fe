# 微信服务端开发



如何监听消息管理？

如何监听自定义菜单的点击事件？

![1597714990796](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1597714990796.png)

需要配置“接口配置信息”，这个配通了，就是说，微信会发消息给你

但是因为翻墙的原因，本机的ip获取不到，只能通过内网穿透来实现，找了natappfree来实现



使用`koa-xml-body` 来解析 xml 格式文件

但是需要注意的是，`app.use(xmlParser());`  要放在 `app.use(bodyParser());` 前面



关于内网穿透，本来用natapp，但是偶尔会连接不上，又查了查，找到最好的内网穿透的工具：ngrok

好用且稳定





### 关于media_id

想在公众号里回复图片，视频或者图文，就要有media_id。找了半圈，新增临时素材能获取media_id。有效期是3天



调用新增临时素材的话，需要上传照片



https://developers.weixin.qq.com/community/develop/doc/00000ef32dc64883d9d93f31f56800



坑点，axios请求怎么样也上传不了照片



最坑的地方来了

微信测试号不能上传 永久media_id，但是文档没写，

永久素材可以一般要在有素材内容的公众号里直接拿过来，点击返回XX

https://segmentfault.com/q/1010000012972666



什么是 access_token

> access_token 是公众号的全局唯一票据，公众号调用各接口时都需使用access_token。有效期为2小时，且一天最多只能调用2000次

这样的话，access_token 必须缓存起来（不然它只有2000次调用）

我们定时每1个小时刷新一次，一天也就调用24次，搓搓有余了。

思路是这样，调用XX方法，如果有缓存，用缓存的；如果没有，去调用接口。

每一个小时去调用一次接口





什么是 jsapi_ticket

jsapi_ticket 是公众号用于调用微信JS接口的临时票据。一般为2小时，通过access_token获取。



无论是 access_token 还是 jsapi_ticket ，都需要进行缓存







**如何让在koa中使用redis ，让redis 同步**



加入一个库 async-redis

让它支持异步





定时node-schedule 接入，每一小时定时获取accesstoken



网页与微信的授权 

1、以 snsapi_base 为 scope 发起的网页授权，静默授权，用户无感知

2、以 snsapi_userinfo 为 scope 发起的网页授权，能获取用户的基本信息，但需要用户手动统一





H5想要调用微信JS-SDK,需要5步。接入jssdk，微信后台绑定域名之类的，

但是服务器端也要做支持，比如提供签名算法，

```javascript
wx.config({
  debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
  appId: '', // 必填，公众号的唯一标识
  timestamp: , // 必填，生成签名的时间戳
  nonceStr: '', // 必填，生成签名的随机串
  signature: '',// 必填，签名
  jsApiList: [] // 必填，需要使用的JS接口列表
});
```

签名算法 通过appId， timestamp， nonceStr， signature 四个参数得到一个值，正确你调用才是通的















对用户的标签管理，打标签，根据业务来，

个性化菜单栏 通过标签来展示不同的菜单栏















