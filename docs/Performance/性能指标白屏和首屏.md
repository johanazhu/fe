# 性能指标一点通

目录

性能分析的工具

- Lighthouse
- web-vitals 官方标准
- performance

性能监控指标

- 白屏时间 FP
- 首次内容绘制时间 FCP
- 最大内容绘制时间 LCP
- 累积布局偏移值  CLS
- 首字节时间 TTFB
- 首次输入延迟时间 FID
- 可交互时间 TTI
- 总阻塞时间 TBT
- 首页加载时间
- 首屏加载时间
- DOM 渲染时间
- window.onload 时间

如何检测白屏

- 检测根节点是否渲染
- Mutation Observer 监听 DOM 变化
- 页面截图检测
- 采样对比



FP：首次绘制。浏览器首次在屏幕上绘制像素的时间点，即页面开始显示内容的时间

FCP：首次有内容绘制。页面首次绘制任何文本、图像或者其他可视元素的时间点，用户可以看到页面有一些可见的呢空

LCP：最大内容绘制。页面中最大的可见内容元素绘制完成并可见的时间点，通常是页面上最显眼的图像或文本块

TTI：可交互时间。页面加载完成且用户可以与页面进行交互的时间点，主线程空闲且页面响应用户输入

TBT：总阻塞时间。页面加载过程中，主线程被长时间任何（通常是 JavaScript 执行）阻塞的总时间

CLS：累计布局便宜。页面加载过程中发生的意外布局变化的总量，可能导致用户在交互时误触或出现不良体验

FID：首次输入延迟。用户首次与页面交互（如点击按钮）时，页面响应用户输入所需的时间





## 性能分析的工具



### Lighthouse

#### Lighthouse 列出 Performance 各指标得分

Performance 列出了`FCP、SP、LCP、TTI、TBI、CLS` 六个指标的用时和得分情况



### web-vitals 官方标准

[web-vitals](https://www.npmjs.com/package/web-vitals)是 Googl e的一项计划，目的是为了统一衡量性能的标准，并提出一些核心性能指标，以此作为参考，从而定义页面的体验质量，而这些核心性能指标，就是**Core Web Vitals**。





**官方指标标准**

| 指标                          | 作用                                                     | 标准            |
| ----------------------------- | -------------------------------------------------------- | --------------- |
| FCP(First Contentful Paint)   | 首次内容绘制时间                                         | 标准 ≤1s        |
| LCP(Largest Contentful Paint) | 最大内容绘制时间                                         | 标准 ≤2 秒      |
| FID(first input delay)        | 首次输入延迟，标准是用户触发后，到浏览器响应时间         | 标准 ≤100ms     |
| CLS(Cumulative Layout Shift)  | 累积布局偏移                                             | 标准 ≤0.1       |
| TTFB(Time to First Byte)      | 页面发出请求，到接收第一个字节所花费的毫秒数(首字节时间) | 标准<= 100 毫秒 |



### performance







## 页面监控的指标有哪些

### Core Web Vitals





### LCP：Largest Contentful Paint

最大内容绘制完成时间，即在用户的可见窗口内的最大的图片元素或块级元素的渲染时间，主要考虑的元素有以下这些

- `<img>元素`
- `<image>元素内的<svg>元素`
- `<video>元素`
- CSS中通过url()加载背景图片的元素
- 包含文本节点或其他内联级文本元素子级的块级元素

### Time To Interactive（TTI）

**一、定义**

页面可交互时间，即从页面开始加载，一直到用户可以自由输入或操作页面的时间。

**二、作用**

该指标用来衡量一个页面真正可用的时间，而并不仅仅是可看，输入框是否可输入、表单是否可提交等。



**Time To First Byte（TTFB）**

首字节时间，表示用户从开始访问页面url之后，到服务端返回了第一个字节的这段时间。

```js
// TTFB time
const ttfb = performanceTiming.responseStart - performanceTiming.navigationStart;
```

**Request**

http请求耗时，不包含tcp连接。

```js
// request time
const request = performanceNavigationTiming.responseEnd - performanceNavigationTiming.requestStart;
```

**DOMContentLoaded（DCL）**

初始的 HTML 文档被完全加载和解析完成的耗时。

```js
// domcontentloaded time
const dcl = performanceTiming.domContentLoadedEventStart - performanceTiming.navigationStart;
```

**注：PerformanceTiming兼容性较好，目前真机上实践后未发现任何兼容性问题，但是官方不再建议使用该API，建议尽快升级到level 2.**



## 应用监控

即用哪些软件可以监控性能

### Lighthouse 分析：F12 中查看



### [PageSpeed Insights](https://pagespeed.web.dev/)

PSI跑分内部也是集成了LightHouse，所以分值差异不大







## 白屏时间

白屏时间指的是浏览器开始显示内容的时间。因此我们只需要知道是浏览器开始显示内容的时间点，即页面白屏结束时间点即可获取到页面的白屏时间。

### 计算白屏时间

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>白屏</title>
  <script type="text/javascript">
    // 不兼容performance.timing 的浏览器，如IE8
    window.pageStartTime = Date.now();
  </script>
  <!-- 页面 CSS 资源 -->
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="page.css">
  <script type="text/javascript">
    // 白屏时间结束点
    window.firstPaint = Date.now();
  </script>
</head>
<body>
  <!-- 页面内容 -->
</body>
</html>
```

因此白屏时间则可以这样计算出：

可使用 Performance API 时：

```javascript
白屏时间 = firstPaint - performance.timing.navigationStart;
```

不可使用 Performance API 时：

```javascript
白屏时间 = firstPaint - pageStartTime;
```



## 首屏时间

首屏时间是指用户打开网站开始，到浏览器首屏内容渲染完成的时间。对于用户体验来说，首屏时间是用户对一个网站的重要体验因素。通常一个网站，如果首屏时间在5秒以内是比较优秀的，10秒以内是可以接受的，10秒以上就不可容忍了。超过10秒的首屏时间用户会选择刷新页面或立刻离开。

通常计算首屏的方法有

- 首屏模块标签标记法
- 统计首屏内加载最慢的图片的时间
- 自定义首屏内容计算法

### 1、首屏模块标签标记法

首屏模块标签标记法，通常适用于首屏内容不需要通过拉取数据才能生存以及页面不考虑图片等资源加载的情况。我们会在 HTML 文档中对应首屏内容的标签结束位置，使用内联的 JavaScript 代码记录当前时间戳。如下所示：

[![复制代码](https://assets.cnblogs.com/images/copycode.gif)](javascript:void(0);)

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>首屏</title>
  <script type="text/javascript">
    window.pageStartTime = Date.now();
  </script>
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="page.css">
</head>
<body>
  <!-- 首屏可见模块1 -->
  <div class="module-1"></div>
  <!-- 首屏可见模块2 -->
  <div class="module-2"></div>
  <script type="text/javascript">
    window.firstScreen = Date.now();
  </script>
  <!-- 首屏不可见模块3 -->
  <div class="module-3"></div>
    <!-- 首屏不可见模块4 -->
  <div class="module-4"></div>
</body>
</html>
```

此时首屏时间等于 `firstScreen - performance.timing.navigationStart;`

事实上首屏模块标签标记法 在业务中的情况比较少，大多数页面都需要通过接口拉取数据才能完整展示，因此我们会使用 JavaScript 脚本来判断首屏页面内容加载情况。

### 2、统计首屏内图片完成加载的时间

通常我们首屏内容加载最慢的就是图片资源，因此我们会把首屏内加载最慢的图片的时间当做首屏的时间。

由于浏览器对每个页面的 TCP 连接数有限制，使得并不是所有图片都能立刻开始下载和显示。因此我们在 DOM树 构建完成后将会去遍历首屏内的所有图片标签，并且监听所有图片标签 onload 事件，最终遍历图片标签的加载时间的最大值，并用这个最大值减去 `navigationStart` 即可获得近似的首屏时间。

此时首屏时间等于 `加载最慢的图片的时间点 - performance.timing.navigationStart;`

### 3、自定义模块内容计算法

由于统计首屏内图片完成加载的时间比较复杂。因此我们在业务中通常会通过自定义模块内容，来简化计算首屏时间。如下面的做法：

- 忽略图片等资源加载情况，只考虑页面主要 DOM
- 只考虑首屏的主要模块，而不是严格意义首屏线以上的所有内容





## 参考资料

- [前端优化-如何计算白屏和首屏时间](https://www.cnblogs.com/longm/p/7382163.html)
- [「历时8个月」10万字前端知识体系总结（工程化篇）](https://juejin.cn/post/7146976516692410376/)
- [前端白屏的检测方案，让你知道自己的页面白了](https://juejin.cn/post/7176206226903007292)
- [原创：别再用performance计算首屏时间了！！](https://github.com/zxyue25/blog/issues/1)
